<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramount Commission Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Lato:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', 'Lato', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #12096d 0%, #18efe4 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            max-width: 500px;
            margin: 100px auto;
            text-align: center;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #12096d;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo svg {
            height: 40px;
            width: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .role-admin { background: #fff3cd; color: #856404; }
        .role-manager { background: #d4edda; color: #155724; }
        .role-user { background: #d1ecf1; color: #0c5460; }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #12096d 0%, #18efe4 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(18, 9, 109, 0.4);
        }

        .btn-success { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-danger { background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }

        .permission-denied {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #dc3545;
            margin: 20px 0;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #12096d 0%, #18efe4 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .commission-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .commission-table th,
        .commission-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .commission-table th {
            background: linear-gradient(135deg, #12096d 0%, #18efe4 100%);
            color: white;
            font-weight: 600;
        }

        .commission-table tbody tr:hover {
            background: linear-gradient(90deg, #f8f9ff 0%, #ffffff 100%);
        }

        .hidden { display: none; }

        .file-upload {
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed #12096d;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: #18efe4;
            background: rgba(255, 255, 255, 1);
        }

        .file-input {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }

        .log-container {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #00ff88;
            border-radius: 15px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .tier-indicator {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tier-base { background: #e3f2fd; color: #1565c0; }
        .tier-1 { background: #fff3e0; color: #e65100; }
        .tier-2 { background: #f3e5f5; color: #7b1fa2; }

        .admin-only { border-left: 4px solid #ffc107; padding-left: 15px; }
        .manager-only { border-left: 4px solid #28a745; padding-left: 15px; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #12096d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-container">
            <div style="margin-bottom: 30px;">
                <svg height="60" viewBox="0 0 1500 952.02" style="max-width: 300px;">
                    <defs>
                        <linearGradient id="linear-gradient" x1="427.35" y1="288.78" x2="1055.89" y2="288.78" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#18efe4"/>
                            <stop offset="1" stop-color="#12096d"/>
                        </linearGradient>
                        <linearGradient id="linear-gradient-2" x1="216.99" y1="839.76" x2="1268.21" y2="839.76" gradientUnits="userSpaceOnUse">
                            <stop offset="0" stop-color="#18efe4"/>
                            <stop offset="1" stop-color="#12096d"/>
                        </linearGradient>
                    </defs>
                    <g>
                        <polygon fill="url(#linear-gradient)" points="451.77 560.41 740.26 59.41 1031.42 560.41 1055.89 560.41 740.17 17.16 427.35 560.41 451.77 560.41"/>
                        <polygon fill="url(#linear-gradient-2)" points="1143.81 753.79 1231.44 904.58 253.59 904.58 340.42 753.79 316 753.79 216.99 925.74 1268.21 925.74 1168.28 753.79 1143.81 753.79"/>
                    </g>
                    <g fill="#12096d">
                        <path d="M97.81,605.73c8.14,7.07,12.22,16.98,12.22,29.73s-4.1,23.67-12.3,31.01c-8.2,7.35-19.71,11.02-34.52,11.02h-29.73v37.25h-16.4v-119.61h46.14c14.92,0,26.46,3.53,34.6,10.6ZM86.11,655.88c5.47-4.5,8.2-11.13,8.2-19.91s-2.73-15.01-8.2-19.4c-5.47-4.38-13.33-6.58-23.58-6.58l-29.05.17v52.46h29.05c10.25,0,18.11-2.25,23.58-6.75Z"/>
                        <path d="M256.3,714.75l-12.64-29.05h-63.05l-12.47,29.05h-17.26l53.14-119.61h17.09l52.97,119.61h-17.77ZM187.1,670.84h50.24l-25.29-58.1-24.95,58.1Z"/>
                        <path d="M411.45,714.75l-23.75-37.59c-2.73.23-4.96.34-6.66.34h-30.42v37.25h-16.4v-119.61h46.82c15.15,0,26.85,3.5,35.12,10.51,8.26,7.01,12.39,16.95,12.39,29.82,0,9.68-2.25,17.83-6.75,24.43-4.5,6.61-10.96,11.39-19.39,14.35l27.85,40.5h-18.8ZM381.03,662.63c10.25,0,18.11-2.25,23.58-6.75,5.47-4.5,8.2-11.13,8.2-19.91s-2.73-15.01-8.2-19.4c-5.47-4.38-13.33-6.58-23.58-6.58h-30.42v52.63h30.42Z"/>
                        <path d="M591.55,714.75l-12.64-29.05h-63.05l-12.47,29.05h-17.26l53.14-119.61h17.09l52.97,119.61h-17.77ZM522.35,670.84h50.24l-25.29-58.1-24.95,58.1Z"/>
                        <path d="M669.46,595.14h19.48l43.74,84.07,43.4-84.07h19.65v119.61h-15.38l-.17-95.52-42.55,82.88h-10.08l-42.89-82.88v95.52h-15.21v-119.61Z"/>
                        <path d="M956.62,602.14c9.63,5.36,17.23,12.67,22.81,21.96,5.58,9.29,8.37,19.51,8.37,30.67s-2.79,21.44-8.37,30.84c-5.58,9.4-13.19,16.8-22.81,22.21-9.63,5.41-20.19,8.12-31.7,8.12s-22.07-2.7-31.7-8.12c-9.63-5.41-17.23-12.82-22.81-22.21-5.58-9.4-8.37-19.68-8.37-30.84s2.79-21.39,8.37-30.67c5.58-9.28,13.16-16.6,22.73-21.96,9.57-5.35,20.16-8.03,31.78-8.03s22.07,2.68,31.7,8.03ZM901.94,614.96c-7.12,4.1-12.79,9.65-17,16.66-4.22,7.01-6.32,14.72-6.32,23.15s2.1,16.18,6.32,23.24c4.21,7.07,9.88,12.67,17,16.83,7.12,4.16,14.84,6.24,23.15,6.24s15.97-2.08,22.98-6.24c7.01-4.16,12.59-9.76,16.74-16.83,4.16-7.06,6.24-14.81,6.24-23.24s-2.08-16.15-6.24-23.15c-4.16-7.01-9.74-12.56-16.74-16.66-7.01-4.1-14.67-6.15-22.98-6.15s-16.04,2.05-23.15,6.15Z"/>
                        <path d="M1077.08,691.77c6.09,6.21,14.49,9.31,25.2,9.31s18.91-3.1,24.95-9.31c6.04-6.21,9.06-14.84,9.06-25.89v-70.74h16.4v70.74c0,15.61-4.47,27.85-13.41,36.74-8.94,8.89-21.27,13.33-36.99,13.33s-28.25-4.44-37.25-13.33c-9-8.89-13.5-21.13-13.5-36.74v-70.74h16.4v70.74c0,11.05,3.05,19.68,9.14,25.89Z"/>
                        <path d="M1312.12,595.14h16.23v119.61h-16.57l-68.35-92.61v92.61h-16.4v-119.61h16.57l68.52,92.79v-92.79Z"/>
                        <path d="M1390.04,595.14h93.47v15.04h-38.62v104.57h-16.4v-104.57h-38.45v-15.04Z"/>
                    </g>
                </svg>
            </div>

            <h4 style="color: #12096d; margin-bottom: 20px;">Select Your Access Level</h4>
            
            <div style="margin-bottom: 20px;">
                <button class="btn" onclick="loginAs('admin', 'Administrator', '473682')" style="width: 200px;">Administrator</button><br>
                <small style="color: #666;">Full access to all data and system management</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="loginAs('manager', 'Sales Manager', 'MGR001', ['REC001', 'SAL001'])" style="width: 200px;">Manager</button><br>
                <small style="color: #666;">View team data and upload commission files</small>
            </div>
            
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" onclick="loginAs('user', 'John Smith', 'REC001')" style="width: 200px;">Employee</button><br>
                <small style="color: #666;">View personal commission data only</small>
            </div>
        </div>

        <!-- Main Application -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <div class="header">
                <div class="logo">
                    <svg height="40" viewBox="0 0 1500 952.02">
                        <defs>
                            <linearGradient id="header-gradient" x1="427.35" y1="288.78" x2="1055.89" y2="288.78" gradientUnits="userSpaceOnUse">
                                <stop offset="0" stop-color="#18efe4"/>
                                <stop offset="1" stop-color="#12096d"/>
                            </linearGradient>
                            <linearGradient id="header-gradient-2" x1="216.99" y1="839.76" x2="1268.21" y2="839.76" gradientUnits="userSpaceOnUse">
                                <stop offset="0" stop-color="#18efe4"/>
                                <stop offset="1" stop-color="#12096d"/>
                            </linearGradient>
                        </defs>
                        <g>
                            <polygon fill="url(#header-gradient)" points="451.77 560.41 740.26 59.41 1031.42 560.41 1055.89 560.41 740.17 17.16 427.35 560.41 451.77 560.41"/>
                            <polygon fill="url(#header-gradient-2)" points="1143.81 753.79 1231.44 904.58 253.59 904.58 340.42 753.79 316 753.79 216.99 925.74 1268.21 925.74 1168.28 753.79 1143.81 753.79"/>
                        </g>
                        <g fill="#12096d">
                            <path d="M97.81,605.73c8.14,7.07,12.22,16.98,12.22,29.73s-4.1,23.67-12.3,31.01c-8.2,7.35-19.71,11.02-34.52,11.02h-29.73v37.25h-16.4v-119.61h46.14c14.92,0,26.46,3.53,34.6,10.6ZM86.11,655.88c5.47-4.5,8.2-11.13,8.2-19.91s-2.73-15.01-8.2-19.4c-5.47-4.38-13.33-6.58-23.58-6.58l-29.05.17v52.46h29.05c10.25,0,18.11-2.25,23.58-6.75Z"/>
                            <path d="M256.3,714.75l-12.64-29.05h-63.05l-12.47,29.05h-17.26l53.14-119.61h17.09l52.97,119.61h-17.77ZM187.1,670.84h50.24l-25.29-58.1-24.95,58.1Z"/>
                            <path d="M411.45,714.75l-23.75-37.59c-2.73.23-4.96.34-6.66.34h-30.42v37.25h-16.4v-119.61h46.82c15.15,0,26.85,3.5,35.12,10.51,8.26,7.01,12.39,16.95,12.39,29.82,0,9.68-2.25,17.83-6.75,24.43-4.5,6.61-10.96,11.39-19.39,14.35l27.85,40.5h-18.8ZM381.03,662.63c10.25,0,18.11-2.25,23.58-6.75,5.47-4.5,8.2-11.13,8.2-19.91s-2.73-15.01-8.2-19.4c-5.47-4.38-13.33-6.58-23.58-6.58h-30.42v52.63h30.42Z"/>
                            <path d="M591.55,714.75l-12.64-29.05h-63.05l-12.47,29.05h-17.26l53.14-119.61h17.09l52.97,119.61h-17.77ZM522.35,670.84h50.24l-25.29-58.1-24.95,58.1Z"/>
                            <path d="M669.46,595.14h19.48l43.74,84.07,43.4-84.07h19.65v119.61h-15.38l-.17-95.52-42.55,82.88h-10.08l-42.89-82.88v95.52h-15.21v-119.61Z"/>
                            <path d="M956.62,602.14c9.63,5.36,17.23,12.67,22.81,21.96,5.58,9.29,8.37,19.51,8.37,30.67s-2.79,21.44-8.37,30.84c-5.58,9.4-13.19,16.8-22.81,22.21-9.63,5.41-20.19,8.12-31.7,8.12s-22.07-2.7-31.7-8.12c-9.63-5.41-17.23-12.82-22.81-22.21-5.58-9.4-8.37-19.68-8.37-30.84s2.79-21.39,8.37-30.67c5.58-9.28,13.16-16.6,22.73-21.96,9.57-5.35,20.16-8.03,31.78-8.03s22.07,2.68,31.7,8.03ZM901.94,614.96c-7.12,4.1-12.79,9.65-17,16.66-4.22,7.01-6.32,14.72-6.32,23.15s2.1,16.18,6.32,23.24c4.21,7.07,9.88,12.67,17,16.83,7.12,4.16,14.84,6.24,23.15,6.24s15.97-2.08,22.98-6.24c7.01-4.16,12.59-9.76,16.74-16.83,4.16-7.06,6.24-14.81,6.24-23.24s-2.08-16.15-6.24-23.15c-4.16-7.01-9.74-12.56-16.74-16.66-7.01-4.1-14.67-6.15-22.98-6.15s-16.04,2.05-23.15,6.15Z"/>
                            <path d="M1077.08,691.77c6.09,6.21,14.49,9.31,25.2,9.31s18.91-3.1,24.95-9.31c6.04-6.21,9.06-14.84,9.06-25.89v-70.74h16.4v70.74c0,15.61-4.47,27.85-13.41,36.74-8.94,8.89-21.27,13.33-36.99,13.33s-28.25-4.44-37.25-13.33c-9-8.89-13.5-21.13-13.5-36.74v-70.74h16.4v70.74c0,11.05,3.05,19.68,9.14,25.89Z"/>
                            <path d="M1312.12,595.14h16.23v119.61h-16.57l-68.35-92.61v92.61h-16.4v-119.61h16.57l68.52,92.79v-92.79Z"/>
                            <path d="M1390.04,595.14h93.47v15.04h-38.62v104.57h-16.4v-104.57h-38.45v-15.04Z"/>
                        </g>
                    </svg>
                    <span>Commission Portal</span>
                </div>
                <div class="user-info">
                    <span id="welcomeText">User</span>
                    <span id="roleBadge" class="role-badge role-user">User</span>
                    <button class="btn btn-danger" onclick="logout()" style="font-size: 12px; padding: 8px 15px;">Logout</button>
                </div>
            </div>

            <!-- Admin Only: System Management -->
            <div id="adminContent" class="main-content admin-only hidden">
                <h3>System Administration</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <button class="btn btn-success" onclick="manageUsers()">Manage Users</button>
                    <button class="btn btn-secondary" onclick="viewSystemLogs()">System Logs</button>
                    <button class="btn" onclick="exportAllData()">Export All Data</button>
                    <button class="btn btn-secondary" onclick="configureSettings()">Configure Settings</button>
                </div>
            </div>

            <!-- Manager/Admin: File Upload -->
            <div id="managerContent" class="main-content manager-only hidden">
                <h3>Upload Commission Files</h3>
                
                <div class="file-upload">
                    <h4 style="color: #12096d; margin-bottom: 15px;">Master Structure File</h4>
                    <input type="file" id="masterFile" class="file-input" accept=".xlsx,.xls" />
                    <p style="color: #666; font-size: 14px;">Upload your Master Structure Excel file with employee commission rules</p>
                </div>

                <div class="file-upload">
                    <h4 style="color: #12096d; margin-bottom: 15px;">TOA Files</h4>
                    <input type="file" id="toaFiles" class="file-input" accept=".csv,.xlsx" multiple />
                    <p style="color: #666; font-size: 14px;">Upload your Bullhorn TOA files (CSV or Excel) - can select multiple files</p>
                </div>

                <div style="text-align: center; margin: 30px 0;">
                    <button class="btn btn-success" onclick="processCommissionFiles()">
                        <span id="uploadButtonText">Calculate Commissions</span>
                        <span id="uploadSpinner" class="loading hidden"></span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearFiles()">Clear Files</button>
                </div>
            </div>

            <!-- All Users: Commission Dashboard -->
            <div class="main-content">
                <h3 id="dashboardTitle">Commission Dashboard</h3>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalCommission">$0</div>
                        <div class="stat-label">Total Commission</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalGP">$0</div>
                        <div class="stat-label">Total Gross Profit</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgCommissionRate">0%</div>
                        <div class="stat-label">Average Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="uniqueEmployees">0</div>
                        <div class="stat-label">Employees</div>
                    </div>
                </div>

                <table class="commission-table">
                    <thead>
                        <tr>
                            <th>Week Ending</th>
                            <th>Employee</th>
                            <th>Client</th>
                            <th>Gross Profit</th>
                            <th>Cumulative GP</th>
                            <th>Tier</th>
                            <th>Rate</th>
                            <th>Commission</th>
                        </tr>
                    </thead>
                    <tbody id="commissionTableBody">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                <span id="tableMessage">Select your role above to view commission data</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Activity Log -->
            <div class="log-container" id="logContainer">
                <div style="color: #00ff88;">[SYSTEM] Paramount Commission Portal - Azure hosted with authentication</div>
                <div style="color: #87ceeb;">[INFO] Role-based access control enabled</div>
                <div style="color: #ffd700;">[READY] Select your access level to begin</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // User session management
        let currentUser = {
            userId: null,
            role: null,
            name: null,
            employeeId: null,
            managedEmployees: [],
            permissions: []
        };

        let commissionData = [];

        // Permission system
        const PERMISSIONS = {
            VIEW_ALL_DATA: 'view_all_data',
            UPLOAD_FILES: 'upload_files', 
            MANAGE_USERS: 'manage_users',
            VIEW_SYSTEM_LOGS: 'view_system_logs',
            EXPORT_DATA: 'export_data',
            VIEW_OWN_DATA: 'view_own_data'
        };

        const ROLE_PERMISSIONS = {
            admin: [
                PERMISSIONS.VIEW_ALL_DATA,
                PERMISSIONS.UPLOAD_FILES,
                PERMISSIONS.MANAGE_USERS,
                PERMISSIONS.VIEW_SYSTEM_LOGS,
                PERMISSIONS.EXPORT_DATA,
                PERMISSIONS.VIEW_OWN_DATA
            ],
            manager: [
                PERMISSIONS.VIEW_ALL_DATA,
                PERMISSIONS.UPLOAD_FILES,
                PERMISSIONS.VIEW_OWN_DATA
            ],
            user: [
                PERMISSIONS.VIEW_OWN_DATA
            ]
        };

        // Authentication system
        function loginAs(role, name, employeeId, managedEmployees = []) {
            currentUser = {
                userId: `user_${employeeId}`,
                role: role,
                name: name,
                employeeId: employeeId,
                managedEmployees: managedEmployees,
                permissions: ROLE_PERMISSIONS[role] || []
            };

            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            updateUIForRole();
            log(`Logged in as ${currentUser.name} (${role})`, 'success');
        }

        function logout() {
            currentUser = { userId: null, role: null, name: null, employeeId: null, managedEmployees: [], permissions: [] };
            commissionData = [];
            
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            log('Logged out successfully', 'info');
        }

        function hasPermission(permission) {
            return currentUser.permissions.includes(permission);
        }

        function updateUIForRole() {
            const welcomeText = document.getElementById('welcomeText');
            const roleBadge = document.getElementById('roleBadge');
            const dashboardTitle = document.getElementById('dashboardTitle');
            const tableMessage = document.getElementById('tableMessage');
            
            welcomeText.textContent = currentUser.name;
            roleBadge.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            roleBadge.className = `role-badge role-${currentUser.role}`;
            
            // Show/hide content based on role
            const adminContent = document.getElementById('adminContent');
            const managerContent = document.getElementById('managerContent');
            
            if (currentUser.role === 'admin') {
                adminContent.classList.remove('hidden');
                managerContent.classList.remove('hidden');
                dashboardTitle.textContent = 'Commission Dashboard - All Employees';
                tableMessage.textContent = 'Loading all commission data...';
            } else if (currentUser.role === 'manager') {
                adminContent.classList.add('hidden');
                managerContent.classList.remove('hidden');
                dashboardTitle.textContent = 'Commission Dashboard - Your Team';
                tableMessage.textContent = 'Loading team commission data...';
            } else {
                adminContent.classList.add('hidden');
                managerContent.classList.add('hidden');
                dashboardTitle.textContent = 'Your Commission Dashboard';
                tableMessage.textContent = 'Loading your commission data...';
            }

            // Load user's commission data
            loadUserCommissionData();
        }

        // Load commission data - try saved data first, then demo
        async function loadUserCommissionData() {
            try {
                log('Loading commission data...', 'info');
                
                // Try to load from local storage first
                if (loadFromLocalStorage()) {
                    // Filter data based on user role
                    filterDataByRole();
                    updateDashboard();
                    return;
                }
                
                log('No saved data found, loading demo data...', 'warning');
                loadDemoData();

            } catch (error) {
                log(`Error loading data: ${error.message}`, 'error');
                loadDemoData();
            }
        }

        function filterDataByRole() {
            if (currentUser.role === 'user') {
                commissionData = commissionData.filter(record => record.employeeId === currentUser.employeeId);
            } else if (currentUser.role === 'manager') {
                const teamIds = [...currentUser.managedEmployees, currentUser.employeeId];
                commissionData = commissionData.filter(record => teamIds.includes(record.employeeId));
            }
            // Admin sees all data (no filtering)
        }

        // Process commission files via Azure Function
        async function processCommissionFiles() {
            const masterFileInput = document.getElementById('masterFile');
            const toaFilesInput = document.getElementById('toaFiles');
            const uploadButton = document.getElementById('uploadButtonText');
            const uploadSpinner = document.getElementById('uploadSpinner');

            if (!hasPermission(PERMISSIONS.UPLOAD_FILES)) {
                log('You do not have permission to upload files', 'error');
                return;
            }

            if (!masterFileInput.files.length) {
                log('Please select a Master Structure file', 'error');
                return;
            }

            if (!toaFilesInput.files.length) {
                log('Please select at least one TOA file', 'error');
                return;
            }

            try {
                // Show loading state
                uploadButton.textContent = 'Processing...';
                uploadSpinner.classList.remove('hidden');
                
                log('Uploading and processing commission files...', 'info');
                
                // Convert files to base64 for API transmission
                const masterFile = await fileToBase64(masterFileInput.files[0]);
                const toaFiles = await Promise.all(
                    Array.from(toaFilesInput.files).map(file => fileToBase64(file))
                );

                const response = await fetch('/api/process-commission-files', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        masterFile: masterFile,
                        toaFiles: toaFiles,
                        userId: currentUser.userId,
                        userRole: currentUser.role
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    log(`Commission processing completed: ${result.summary.recordCount} records processed`, 'success');
                    log(`Total commission calculated: ${result.summary.totalCommission.toLocaleString()}`, 'success');
                    
                    // Refresh data for all users
                    await loadUserCommissionData();
                } else {
                    throw new Error(result.error || 'Processing failed');
                }

            } catch (error) {
                log(`Error processing files: ${error.message}`, 'error');
            } finally {
                // Reset loading state
                uploadButton.textContent = 'Calculate Commissions';
                uploadSpinner.classList.add('hidden');
            }
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    resolve({
                        name: file.name,
                        content: reader.result.split(',')[1], // Remove data:... prefix
                        size: file.size
                    });
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Clear file inputs
        function clearFiles() {
            document.getElementById('masterFile').value = '';
            document.getElementById('toaFiles').value = '';
            log('File selections cleared', 'info');
        }

        // Update dashboard with Azure data
        function updateDashboard(summary = null) {
            const stats = summary || {
                totalCommission: commissionData.reduce((sum, record) => sum + (record.commission || 0), 0),
                totalGP: commissionData.reduce((sum, record) => sum + (record.grossProfit || 0), 0),
                employeeCount: new Set(commissionData.map(record => record.employeeId)).size,
                recordCount: commissionData.length
            };

            const avgCommissionRate = stats.totalGP > 0 ? (stats.totalCommission / stats.totalGP) * 100 : 0;

            document.getElementById('totalCommission').textContent = `${stats.totalCommission.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
            document.getElementById('totalGP').textContent = `${stats.totalGP.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
            document.getElementById('avgCommissionRate').textContent = `${avgCommissionRate.toFixed(1)}%`;
            document.getElementById('uniqueEmployees').textContent = stats.employeeCount;

            updateCommissionTable();
        }

        function updateCommissionTable() {
            const tableBody = document.getElementById('commissionTableBody');
            tableBody.innerHTML = '';

            if (commissionData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; padding: 40px; color: #666;">No commission data available. Upload files to process commission calculations.</td>';
                tableBody.appendChild(row);
                return;
            }

            commissionData.forEach(record => {
                const row = document.createElement('tr');
                
                const tierClass = record.tierStatus === 'Base' ? 'tier-base' : 
                                 record.tierStatus === 'Tier 1' ? 'tier-1' : 'tier-2';
                
                row.innerHTML = `
                    <td>${new Date(record.date).toLocaleDateString()}</td>
                    <td>
                        <div style="font-weight: bold;">${record.employee}</div>
                        <div style="font-size: 12px; color: #666;">${record.type}</div>
                    </td>
                    <td>${record.client}</td>
                    <td>${record.grossProfit.toLocaleString('en-US')}</td>
                    <td>${record.cumulativeGP.toLocaleString('en-US')}</td>
                    <td><span class="tier-indicator ${tierClass}">${record.tierStatus}</span></td>
                    <td>${(record.commissionRate * 100).toFixed(1)}%</td>
                    <td style="font-weight: bold; color: #28a745;">${record.commission.toLocaleString('en-US', {maximumFractionDigits: 0})}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load demo data for testing when Azure isn't available
        function loadDemoData() {
            const demoData = [
                {
                    date: '2025-01-07',
                    employee: 'Elane Buresi',
                    employeeId: '473682',
                    client: 'ABC Corp',
                    grossProfit: 15000,
                    cumulativeGP: 15000,
                    commissionRate: 0.33,
                    commission: 4950,
                    type: 'Recruiter',
                    tierStatus: 'Base'
                },
                {
                    date: '2025-01-14',
                    employee: 'John Smith',
                    employeeId: 'REC001',
                    client: 'XYZ Ltd',
                    grossProfit: 22000,
                    cumulativeGP: 37000,
                    commissionRate: 0.30,
                    commission: 6600,
                    type: 'Recruiter',
                    tierStatus: 'Base'
                },
                {
                    date: '2025-01-21',
                    employee: 'Jane Doe',
                    employeeId: 'SAL001',
                    client: 'DEF Inc',
                    grossProfit: 18000,
                    cumulativeGP: 18000,
                    commissionRate: 0.28,
                    commission: 5040,
                    type: 'Sales',
                    tierStatus: 'Base'
                }
            ];

            // Filter demo data based on user role
            if (currentUser.role === 'user') {
                commissionData = demoData.filter(record => record.employeeId === currentUser.employeeId);
            } else if (currentUser.role === 'manager') {
                const teamIds = [...currentUser.managedEmployees, currentUser.employeeId];
                commissionData = demoData.filter(record => teamIds.includes(record.employeeId));
            } else {
                commissionData = demoData;
            }

            updateDashboard();
            log('Demo data loaded based on your role', 'info');
        }

        // Admin functions (placeholder implementations)
        function manageUsers() {
            if (!hasPermission(PERMISSIONS.MANAGE_USERS)) {
                log('Access denied: Insufficient permissions', 'error');
                return;
            }
            log('User management feature coming soon', 'info');
        }

        function viewSystemLogs() {
            if (!hasPermission(PERMISSIONS.VIEW_SYSTEM_LOGS)) {
                log('Access denied: Insufficient permissions', 'error');
                return;
            }
            log('System logs feature coming soon', 'info');
        }

        function exportAllData() {
            if (!hasPermission(PERMISSIONS.EXPORT_DATA)) {
                log('Access denied: Insufficient permissions', 'error');
                return;
            }
            
            if (commissionData.length === 0) {
                log('No data to export', 'warning');
                return;
            }

            // Create CSV export
            const headers = ['Date', 'Employee', 'Client', 'Gross Profit', 'Cumulative GP', 'Tier', 'Rate', 'Commission'];
            const csvContent = [
                headers.join(','),
                ...commissionData.map(record => [
                    record.date,
                    `"${record.employee}"`,
                    `"${record.client}"`,
                    record.grossProfit,
                    record.cumulativeGP,
                    record.tierStatus,
                    (record.commissionRate * 100).toFixed(1) + '%',
                    record.commission
                ].join(','))
            ].join('\n');

            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `commission-data-${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            log('Commission data exported to CSV', 'success');
        }

        function configureSettings() {
            if (!hasPermission(PERMISSIONS.MANAGE_USERS)) {
                log('Access denied: Insufficient permissions', 'error');
                return;
            }
            log('Configuration settings feature coming soon', 'info');
        }

        // Logging function with color coding
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            
            let color, prefix;
            switch(type) {
                case 'success': color = '#28a745'; prefix = '[SUCCESS]'; break;
                case 'error': color = '#dc3545'; prefix = '[ERROR]'; break;
                case 'warning': color = '#ffc107'; prefix = '[WARNING]'; break;
                default: color = '#87ceeb'; prefix = '[INFO]'; break;
            }
            
            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `${prefix} [${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            log('Paramount Commission Portal loaded successfully', 'success');
            log('Select your access level to begin using the system', 'info');
        });
    </script>
</body>
</html>
